<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SkinGenius</title>

  <!-- PWA Meta -->
  <meta name="theme-color" content="#ffffff"/>
  <meta name="description" content="A smart assistant for preliminary analysis of skin conditions."/>
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/mr-esmaily/SkinGenius/405144491fadaa87abc66ee9d00e15c14cd047ec/IMG_20250817_063212_060.jpg"/>
  <link rel="manifest" href="manifest.json"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    html,body{height:100%;overflow:hidden}
    body{font-family:'Vazirmatn',sans-serif;background-color:#f8fafc}
    .content-wrapper{overflow-y:auto}
    main{height:100%;max-height:100vh}
    @media (min-width:640px){
      html,body{height:auto;overflow:auto}
      main{height:auto;max-height:none}
      main.results-shown .content-wrapper{overflow-y:auto;max-height:calc(100vh - 100px)}
    }
    .form-input,.custom-select-button,.form-textarea{background:#fff;border-color:#9ca3af;transition:border-color .2s,box-shadow .2s;text-align:right}
    .form-input:focus,.custom-select-button:focus,.form-textarea:focus,.symptom-tag:focus{border-color:#4f46e5;box-shadow:0 0 0 3px rgba(79,70,229,.15);outline:none}
    .file-drop-zone{background:#f9fafb;border:2px dashed #d1d5db;transition:border-color .2s,background-color .2s}
    .file-drop-zone.dragover{border-color:#4f46e5;background:#f0f5ff}
    .btn-primary{background:#4f46e5;color:#fff;transition:background-color .2s,transform .1s;box-shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px -1px rgba(0,0,0,.1)}
    .btn-primary:hover{background:#4338ca;transform:translateY(-1px)}
    .btn-primary:disabled{background:#a5b4fc;cursor:not-allowed;transform:none}
    .btn-secondary{background:#fff;color:#374151;border:1px solid #d1d5db;transition:background-color .2s,color .2s}
    .btn-secondary:hover{background:#f9fafb}
    .validation-error-message{color:#ef4444;font-size:.875rem;margin-top:.5rem;min-height:1.25rem}
    .input-error{border-color:#ef4444!important}
    .symptom-tag{cursor:pointer;border:1px solid #d1d5db;background:#fff;transition:all .2s}
    .symptom-tag.selected{background:#4f46e5;color:#fff;border-color:#4f46e5}
    .form-step{display:none}
    .form-step.active{display:flex;flex-direction:column;height:100%;animation:fadeIn .5s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .custom-select-options{transition:opacity .2s,transform .2s}
    #splash-screen{opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
    #splash-screen.visible{opacity:1;visibility:visible}
    #splash-content{transform:scale(.95);opacity:0;transition:transform .3s,opacity .3s}
    #splash-screen.visible #splash-content{transform:scale(1);opacity:1}
    .accordion-header{cursor:pointer;transition:background-color .3s,border-radius .3s}
    .accordion-content{max-height:0;overflow:hidden;transition:max-height .5s,padding .5s;padding:0 1rem;background:#fff;border-bottom-left-radius:.5rem;border-bottom-right-radius:.5rem}
    .accordion-content p{font-size:.9rem;line-height:1.7;text-align:justify;color:#4b5563}
    .accordion-header .accordion-icon{transition:transform .3s}
    .accordion-item.active .accordion-header{border-bottom-right-radius:0;border-bottom-left-radius:0}
    .accordion-item.active .accordion-header .accordion-icon{transform:rotate(180deg)}
    .accordion-item.active .accordion-content{padding:1.25rem 1rem;border:1px solid #e5e7eb;border-top:none}
  </style>
</head>
<body class="text-slate-800 flex flex-col items-center sm:justify-center p-0 sm:p-6">

  <!-- Splash -->
  <div id="splash-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-60 backdrop-blur-sm">
    <div id="splash-content" class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full m-4 text-right">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">سلب مسئولیت مهم</h2>
      <p class="text-gray-600 mb-6 leading-relaxed">
        این ابزار یک دستیار هوشمند است و نتایج آن بر اساس هوش مصنوعی تولید می‌شود. تحلیل ارائه شده
        <strong>جایگزین نظر پزشک متخصص نیست</strong>. لطفاً برای تشخیص قطعی و درمان، حتماً با یک پزشک مشورت کنید.
      </p>
      <button id="accept-disclaimer" class="w-full btn-primary rounded-lg py-3 px-8 text-base font-semibold">متوجه شدم و ادامه می‌دهم</button>
    </div>
  </div>

  <!-- Update toast -->
  <div id="update-notification" class="hidden fixed bottom-5 right-5 z-50">
    <div class="bg-gray-800 text-white rounded-lg shadow-lg p-4 flex items-center justify-between space-x-4 space-x-reverse">
      <span>نسخه جدیدی در دسترس است!</span>
      <button id="reload-button" class="btn-primary py-2 px-4 text-sm rounded-md">به‌روزرسانی</button>
    </div>
  </div>

  <!-- Main -->
  <main id="main-container" class="relative w-full max-w-3xl bg-white sm:shadow-lg sm:border sm:border-gray-200 overflow-hidden sm:rounded-2xl flex flex-col">
    <div class="content-wrapper flex-grow flex flex-col p-5 sm:p-8 md:p-10">

      <!-- Kebab menu -->
      <div class="absolute top-4 right-4 z-40">
        <div class="relative">
          <button id="menu-button" type="button" aria-haspopup="true" aria-expanded="false"
                  class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  title="گزینه‌ها">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <circle cx="12" cy="5" r="1.8"></circle>
              <circle cx="12" cy="12" r="1.8"></circle>
              <circle cx="12" cy="19" r="1.8"></circle>
            </svg>
          </button>

          <!-- Menu dropdown -->
          <div id="menu-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-xl shadow-lg py-1 text-sm">
            <button id="menu-install" class="w-full text-right px-4 py-2 hover:bg-indigo-50 focus:bg-indigo-50 hidden">
              نصب به‌صورت اپ (PWA)
            </button>
            <button id="menu-update" class="w-full text-right px-4 py-2 hover:bg-indigo-50 focus:bg-indigo-50 hidden">
              به‌روزرسانی PWA
            </button>
            <!-- Divider we will show/hide dynamically -->
            <div id="menu-divider" class="my-1 border-t border-gray-100"></div>
            <button id="menu-share" class="w-full text-right px-4 py-2 hover:bg-indigo-50 focus:bg-indigo-50">
              اشتراک‌گذاری
            </button>
            <button id="menu-reset" class="w-full text-right px-4 py-2 hover:bg-indigo-50 focus:bg-indigo-50">
              شروع مجدد فرم
            </button>
            <button id="menu-about" class="w-full text-right px-4 py-2 hover:bg-indigo-50 focus:bg-indigo-50">
              دربارهٔ SkinGenius
            </button>
          </div>
        </div>
      </div>

      <div class="text-center mb-6 sm:mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">دستیار هوشمند پوست</h1>
        <p id="header-subtitle" class="mt-3 text-gray-500">برای دریافت یک تحلیل اولیه، لطفاً فرم زیر را با دقت تکمیل نمایید.</p>
      </div>

      <div id="progress-container" class="mb-6 sm:mb-8">
        <div class="relative pt-1">
          <div class="flex mb-2 items-center justify-between">
            <div>
              <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-indigo-600 bg-indigo-100">
                مرحله <span id="step-counter">1</span> از 3
              </span>
            </div>
          </div>
          <div class="overflow-hidden h-2 mb-4 text-xs flex rounded-full bg-indigo-100">
            <div id="progress-bar" style="width:33.33%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-500 transition-all duration-500 rounded-full"></div>
          </div>
        </div>
      </div>

      <!-- Form -->
      <form id="skin-analysis-form" novalidate class="flex-grow flex flex-col">
        <div id="form-steps-container" class="flex-grow">

          <!-- Step 1 -->
          <div class="form-step active" data-step="1">
            <fieldset class="flex-grow flex flex-col">
              <legend class="text-xl font-semibold text-gray-800 border-b border-gray-200 pb-4 mb-8">اطلاعات شخصی</legend>
              <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] md:gap-x-6 items-end">
                <div class="mb-6 md:mb-0">
                  <label for="age" class="block text-sm font-medium text-gray-600 mb-2">سن</label>
                  <input type="number" name="age" id="age" required min="2" max="100" class="form-input block w-full rounded-lg shadow-sm sm:text-sm h-12 px-4 border" placeholder="مثال: ۳۴">
                  <p class="validation-error-message" style="visibility:hidden;"></p>
                </div>
                <div class="hidden md:block h-12 border-l border-gray-200 mb-7"></div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">جنسیت</label>
                  <div id="gender-tag-group" class="flex items-center space-x-4 space-x-reverse h-12">
                    <span class="symptom-tag gender-tag flex-1 justify-center items-center flex py-2 rounded-full text-center text-sm" data-value="female" tabindex="0">زن</span>
                    <span class="symptom-tag gender-tag flex-1 justify-center items-center flex py-2 rounded-full text-center text-sm" data-value="male" tabindex="0">مرد</span>
                  </div>
                  <input type="hidden" name="gender" id="gender" required/>
                  <p class="validation-error-message" style="visibility:hidden;"></p>
                </div>
              </div>
            </fieldset>
          </div>

          <!-- Step 2 -->
          <div class="form-step" data-step="2">
            <fieldset class="flex-grow flex flex-direction-col">
              <legend class="text-xl font-semibold text-gray-800 border-b border-gray-200 pb-4 mb-6">جزئیات علائم</legend>
              <div class="grid grid-cols-1 gap-y-4 sm:gap-y-6">
                <div class="relative">
                  <label class="block text-sm font-medium text-gray-600 mb-2">شروع علائم</label>
                  <input type="hidden" name="onset" id="onset" required/>
                  <button type="button" id="onset-button" class="custom-select-button flex items-center justify-between w-full rounded-lg shadow-sm h-12 px-4 border">
                    <span id="onset-label" class="text-gray-500">مدت زمان را انتخاب کنید...</span>
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                  </button>
                  <div id="onset-options" class="custom-select-options absolute z-10 mt-1 w-full bg-white shadow-lg rounded-lg border border-gray-200 hidden opacity-0 transform scale-95">
                    <a href="#" class="block px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 border-b border-gray-100" data-value="دقایق تا ساعت‌ها">دقایق تا ساعت‌ها</a>
                    <a href="#" class="block px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 border-b border-gray-100" data-value="ساعت‌ها تا روزها">ساعت‌ها تا روزها</a>
                    <a href="#" class="block px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 border-b border-gray-100" data-value="روزها تا هفته‌ها">روزها تا هفته‌ها</a>
                    <a href="#" class="block px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 border-b border-gray-100" data-value="هفته‌ها تا ماه‌ها">هفته‌ها تا ماه‌ها</a>
                    <a href="#" class="block px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50" data-value="ماه‌ها تا سال‌ها">ماه‌ها تا سال‌ها</a>
                  </div>
                  <p class="validation-error-message" style="visibility:hidden;"></p>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">علائم (اختیاری)</label>
                  <div class="flex items-center space-x-4 space-x-reverse h-12">
                    <span class="symptom-tag py-2 rounded-full flex-1 text-center text-sm" data-value="itching">خارش</span>
                    <span class="symptom-tag py-2 rounded-full flex-1 text-center text-sm" data-value="pain">درد</span>
                    <span class="symptom-tag py-2 rounded-full flex-1 text-center text-sm" data-value="fever">تب</span>
                    <input type="hidden" name="symptoms" id="symptoms-hidden-input"/>
                  </div>
                </div>

                <div>
                  <label for="additional-info" class="block text-sm font-medium text-gray-600 mb-2">اطلاعات تکمیلی (اختیاری)</label>
                  <textarea id="additional-info" name="additional-info" rows="3" class="form-textarea block w-full rounded-lg shadow-sm sm:text-sm border p-3" placeholder="جزئیات مرتبط دیگر را شرح دهید..."></textarea>
                </div>
              </div>
            </fieldset>
          </div>

          <!-- Step 3 -->
          <div class="form-step" data-step="3">
            <fieldset class="flex-grow flex flex-col">
              <legend class="text-xl font-semibold text-gray-800 border-b border-gray-200 pb-4 mb-6">بارگذاری تصویر</legend>
              <div class="flex-grow flex flex-col justify-center">
                <label class="block text-sm font-medium text-gray-600 mb-2">یک تصویر واضح از ناحیه آسیب دیده بارگذاری کنید</label>
                <input id="file-upload" name="file-upload" type="file" class="sr-only" accept="image/png, image/jpeg, image/jpg" required/>
                <label for="file-upload" id="file-drop-zone" class="relative file-drop-zone flex flex-col items-center justify-center rounded-xl p-4 cursor-pointer w-full flex-grow min-h-[200px]">
                  <div id="upload-prompt" class="absolute inset-0 flex flex-col items-center justify-center text-center p-4">
                    <svg class="mx-auto h-10 w-10 text-gray-400 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <p class="font-semibold text-gray-700 text-sm">برای بارگذاری، اینجا کلیک کنید</p>
                    <p class="text-xs text-gray-500 mt-1">یا فایل را بکشید و رها کنید</p>
                    <p class="text-xs text-gray-500 mt-3">PNG, JPG, JPEG (حداکثر ۱۰ مگابایت)</p>
                  </div>
                  <div id="file-preview" class="absolute inset-0 p-2 hidden flex-col">
                    <div class="flex-1 relative min-h-0">
                      <img id="preview-image" src="" class="absolute inset-0 m-auto max-h-full max-w-full object-contain rounded-lg" alt="پیش‌نمایش تصویر"/>
                    </div>
                    <div class="flex-shrink-0 w-full flex items-center justify-between mt-1">
                      <p id="file-name" class="text-xs font-medium text-gray-800 truncate"></p>
                      <button type="button" id="remove-file" class="p-1 rounded-full hover:bg-red-100 text-red-600 transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/></svg>
                      </button>
                    </div>
                  </div>
                </label>
                <p class="validation-error-message" style="visibility:hidden;"></p>
                <p class="text-xs text-gray-500 mt-2">نکته: برای بهترین نتیجه، از نور خوب و فوکوس واضح اطمینان حاصل کنید.</p>
              </div>
            </fieldset>
          </div>
        </div>

        <!-- Success -->
        <div id="success-message" class="hidden text-center flex-grow flex flex-col">
          <div class="flex-shrink-0 pt-10">
            <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <h2 class="mt-4 text-3xl font-bold text-gray-800">تحلیل اولیه آماده شد</h2>
            <p class="mt-2 text-gray-600 mb-8">برای مشاهده توضیحات، روی هر مورد کلیک کنید.</p>
          </div>
          <div id="analysis-results-accordion" class="space-y-3 text-right flex-grow"></div>
          <div id="results-buttons" class="hidden mt-8 flex flex-col sm:flex-row sm:justify-between gap-4">
            <button type="button" id="revise-button" class="btn-primary rounded-lg py-2.5 px-8 text-sm font-semibold w-full sm:w-[48%]">بررسی توسط پزشک</button>
            <button type="button" id="start-again-button" class="btn-secondary rounded-lg py-2.5 px-8 text-sm font-semibold w-full sm:w-[48%]">شروع مجدد</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Footer nav -->
    <div id="navigation-buttons" class="flex-shrink-0 bg-gray-50 px-6 sm:px-10 py-4 flex justify-between items-center border-t border-gray-200">
      <div>
        <button type="button" id="next-button" class="btn-primary rounded-lg py-2.5 px-8 text-sm font-semibold">بعدی</button>
        <button type="submit" form="skin-analysis-form" id="submit-button" class="btn-primary w-auto inline-flex justify-center items-center rounded-lg py-2.5 px-4 sm:px-8 text-sm font-semibold hidden">
          <span id="submit-button-text">ارسال و اجرای تحلیل</span>
          <svg id="submit-spinner" class="animate-spin h-5 w-5 text-white hidden" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
        </button>
      </div>
      <button type="button" id="prev-button" class="btn-secondary rounded-lg py-2.5 px-8 text-sm font-semibold">قبلی</button>
    </div>
  </main>

  <script>
    /* ---------- PWA (manifest + SW via Blob, per your working setup) ---------- */
    const manifest = {
      name:"SkinGenius",
      short_name:"SkinGenius",
      start_url:".",
      display:"standalone",
      background_color:"#ffffff",
      theme_color:"#ffffff",
      description:"A smart assistant for preliminary analysis of skin conditions.",
      icons:[
        {"src":"https://raw.githubusercontent.com/mr-esmaily/SkinGenius/405144491fadaa87abc66ee9d00e15c14cd047ec/IMG_20250817_063212_060.jpg","sizes":"192x192","type":"image/jpeg"},
        {"src":"https://raw.githubusercontent.com/mr-esmaily/SkinGenius/405144491fadaa87abc66ee9d00e15c14cd047ec/IMG_20250817_063212_060.jpg","sizes":"512x512","type":"image/jpeg"}
      ]
    };
    const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/json'}));
    document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);

    const swCode = `
      const CACHE_NAME='skingenius-cache-v3';
      const urlsToCache=['/','https://cdn.tailwindcss.com',
        'https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap',
        'https://fonts.gstatic.com/s/vazirmatn/v11/Dxx78-e6dG52Wk2bPpz2hLfg_W5o-32b.woff2',
        'https://raw.githubusercontent.com/mr-esmaily/SkinGenius/405144491fadaa87abc66ee9d00e15c14cd047ec/IMG_20250817_063212_060.jpg'];
      self.addEventListener('message',e=>{if(e.data?.type==='SKIP_WAITING')self.skipWaiting()});
      self.addEventListener('install',e=>{
        e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(urlsToCache.map(u=>u.includes('githubusercontent')?new Request(u,{mode:'no-cors'}):u))));
      });
      self.addEventListener('activate',e=>{
        e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE_NAME).map(k=>caches.delete(k)))));
        self.clients.claim();
      });
      self.addEventListener('fetch',e=>{
        e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
      });
    `;
    const swURL = URL.createObjectURL(new Blob([swCode],{type:'application/javascript'}));

    let deferredPrompt=null;
    let waitingWorker=null;

    if('serviceWorker' in navigator){
      const updateButton=document.getElementById('reload-button');
      const updateNotification=document.getElementById('update-notification');

      function showUpdateNotification(worker){
        updateNotification.classList.remove('hidden');
        updateButton.addEventListener('click',()=>worker.postMessage({type:'SKIP_WAITING'}));
      }

      async function registerServiceWorker(){
        try{
          const reg=await navigator.serviceWorker.register(swURL);
          if(reg.waiting){ waitingWorker=reg.waiting; showUpdateNotification(reg.waiting); refreshPWAButtons?.(); }
          reg.addEventListener('updatefound',()=>{
            const nw=reg.installing;
            nw?.addEventListener('statechange',()=>{
              if(nw.state==='installed'&&navigator.serviceWorker.controller){
                waitingWorker=nw; showUpdateNotification(nw); refreshPWAButtons?.();
              }
            });
          });
        }catch(e){ console.log('SW registration failed:',e); }
      }

      let refreshing=false;
      navigator.serviceWorker.addEventListener('controllerchange',()=>{
        if(!refreshing){ refreshing=true; location.reload(); }
      });

      window.addEventListener('load',registerServiceWorker);
    }

    window.addEventListener('beforeinstallprompt',e=>{
      e.preventDefault(); deferredPrompt=e; refreshPWAButtons?.();
    });
    window.addEventListener('appinstalled',()=>{ deferredPrompt=null; refreshPWAButtons?.(); });

    /* ------------------------ App logic & UI ------------------------ */
    document.addEventListener('DOMContentLoaded',function(){
      /* Splash */
      const splashScreen=document.getElementById('splash-screen');
      const acceptDisclaimerBtn=document.getElementById('accept-disclaimer');
      const ageInput=document.getElementById('age');
      setTimeout(()=>splashScreen.classList.add('visible'),100);
      acceptDisclaimerBtn.addEventListener('click',()=>{
        splashScreen.classList.remove('visible');
        setTimeout(()=>{ splashScreen.style.display='none'; ageInput.focus(); },300);
      });

      /* Form basics */
      const mainContainer=document.getElementById('main-container');
      const form=document.getElementById('skin-analysis-form');
      const steps=[...document.querySelectorAll('.form-step')];
      const prevButton=document.getElementById('prev-button');
      const nextButton=document.getElementById('next-button');
      const submitButton=document.getElementById('submit-button');
      const progressBar=document.getElementById('progress-bar');
      const stepCounter=document.getElementById('step-counter');
      const navigationButtons=document.getElementById('navigation-buttons');
      const resultsButtons=document.getElementById('results-buttons');
      const startAgainButton=document.getElementById('start-again-button');
      const successMessage=document.getElementById('success-message');
      const formStepsContainer=document.getElementById('form-steps-container');
      const progressContainer=document.getElementById('progress-container');
      let currentStep=1;
      const stepFields={1:['age','gender'],2:['onset'],3:['file-upload']};

      ageInput.addEventListener('keydown',e=>{
        if(e.key==='Enter'){ e.preventDefault(); document.querySelector('.gender-tag')?.focus(); }
      });

      function updateButtons(){
        prevButton.style.visibility=currentStep===1?'hidden':'visible';
        nextButton.classList.toggle('hidden',currentStep===steps.length);
        submitButton.classList.toggle('hidden',currentStep!==steps.length);
      }
      function goToStep(n){
        steps.forEach(s=>s.classList.toggle('active',parseInt(s.dataset.step)===n));
        currentStep=n; progressBar.style.width=`${(n/steps.length)*100}%`; stepCounter.textContent=n; updateButtons();
      }
      nextButton.addEventListener('click',()=>{ if(validateCurrentStep()&&currentStep<steps.length) goToStep(currentStep+1); });
      prevButton.addEventListener('click',()=>{ if(currentStep>1) goToStep(currentStep-1); });

      /* Custom select */
      const onsetButton=document.getElementById('onset-button');
      const onsetLabel=document.getElementById('onset-label');
      const onsetOptions=document.getElementById('onset-options');
      const onsetInput=document.getElementById('onset');
      onsetButton.addEventListener('click',()=>{ onsetOptions.classList.toggle('hidden'); onsetOptions.classList.toggle('opacity-0'); onsetOptions.classList.toggle('scale-95'); });
      onsetOptions.querySelectorAll('a').forEach(opt=>{
        opt.addEventListener('click',e=>{
          e.preventDefault(); onsetLabel.textContent=opt.textContent; onsetLabel.classList.remove('text-gray-500');
          onsetInput.value=opt.dataset.value; onsetOptions.classList.add('hidden','opacity-0','scale-95'); validateField('onset');
        });
      });
      document.addEventListener('click',e=>{ if(!onsetButton.contains(e.target)&&!onsetOptions.contains(e.target)) onsetOptions.classList.add('hidden','opacity-0','scale-95'); });

      /* Gender tags */
      const genderTags=document.querySelectorAll('.gender-tag');
      const genderInput=document.getElementById('gender');
      genderTags.forEach(tag=>{
        tag.addEventListener('click',()=>{ genderTags.forEach(t=>t.classList.remove('selected')); tag.classList.add('selected'); genderInput.value=tag.dataset.value; validateField('gender'); });
        tag.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); tag.click(); }});
      });

      /* Symptom tags */
      const symptomTags=document.querySelectorAll('.symptom-tag:not(.gender-tag)');
      const symptomsInput=document.getElementById('symptoms-hidden-input');
      let selectedSymptoms=[];
      symptomTags.forEach(tag=>{
        tag.addEventListener('click',()=>{
          tag.classList.toggle('selected'); const v=tag.dataset.value;
          if(tag.classList.contains('selected')) selectedSymptoms.push(v); else selectedSymptoms=selectedSymptoms.filter(s=>s!==v);
          symptomsInput.value=selectedSymptoms.join(',');
        });
      });

      /* File upload */
      const fileUpload=document.getElementById('file-upload');
      const previewImage=document.getElementById('preview-image');
      const fileDropZone=document.getElementById('file-drop-zone');
      const uploadPrompt=document.getElementById('upload-prompt');
      const filePreview=document.getElementById('file-preview');
      const fileNameDisplay=document.getElementById('file-name');
      const removeFileBtn=document.getElementById('remove-file');

      function handleFiles(files){
        if(files.length>0){
          const f=files[0]; fileNameDisplay.textContent=f.name;
          const reader=new FileReader(); reader.onload=e=>previewImage.src=e.target.result; reader.readAsDataURL(f);
          uploadPrompt.classList.add('hidden'); filePreview.classList.remove('hidden'); filePreview.classList.add('flex'); validateField('file-upload');
        }
      }
      fileUpload.addEventListener('change',function(){ handleFiles(this.files); });
      removeFileBtn.addEventListener('click',e=>{
        e.preventDefault(); e.stopPropagation(); fileUpload.value=''; uploadPrompt.classList.remove('hidden'); filePreview.classList.add('hidden'); previewImage.src=''; validateField('file-upload');
      });
      ['dragenter','dragover','dragleave','drop'].forEach(n=>fileDropZone.addEventListener(n,e=>{e.preventDefault();e.stopPropagation();},false));
      ['dragenter','dragover'].forEach(n=>fileDropZone.addEventListener(n,()=>fileDropZone.classList.add('dragover'),false));
      ['dragleave','drop'].forEach(n=>fileDropZone.addEventListener(n,()=>fileDropZone.classList.remove('dragover'),false));
      fileDropZone.addEventListener('drop',e=>{ const files=e.dataTransfer.files; if(files.length>0){ fileUpload.files=files; handleFiles(files);} },false);

      form.addEventListener('keydown',e=>{
        if(e.key==='Enter'&&document.activeElement.tagName!=='TEXTAREA'){
          if(document.activeElement.id!=='age'){ e.preventDefault(); if(currentStep<steps.length) nextButton.click(); else submitButton.click(); }
        }
      });

      /* Validation */
      const getErrorField=(el)=>{
        if(el.name==='onset') return document.querySelector('#onset-options + .validation-error-message');
        if(el.type==='file') return document.getElementById('file-drop-zone').nextElementSibling;
        return el.closest('div').querySelector('.validation-error-message');
      };
      const validateField=(fieldId)=>{
        let ok=true,msg=''; const el=document.getElementById(fieldId)||document.querySelector(`[name="${fieldId}"]`);
        if(fieldId==='gender'){
          const target=document.getElementById('gender-tag-group');
          const err=document.querySelector('#gender-tag-group + input + .validation-error-message');
          target.classList.remove('input-error'); err.style.visibility='hidden';
          if(!el.value){ ok=false; msg='لطفاً جنسیت را انتخاب کنید.'; target.classList.add('input-error'); err.textContent=msg; err.style.visibility='visible'; }
          return ok;
        }
        const err=getErrorField(el);
        const target=el.name==='onset'?onsetButton:(el.type==='file'?document.getElementById('file-drop-zone'):el);
        if(el.id==='file-upload'){
          if(el.files.length===0 && !previewImage.src.startsWith('data:image')){ ok=false; msg='لطفاً یک تصویر بارگذاری کنید.'; }
        }else{
          if(!el.value){ ok=false; msg='این فیلد الزامی است.'; }
          else if(el.min && parseInt(el.value)<parseInt(el.min)){ ok=false; msg=`مقدار باید حداقل ${el.min} باشد.`; }
          else if(el.max && parseInt(el.value)>parseInt(el.max)){ ok=false; msg=`مقدار باید حداکثر ${el.max} باشد.`; }
        }
        target.classList.remove('input-error'); if(err){ err.style.visibility='hidden'; err.textContent=''; }
        if(!ok){ target.classList.add('input-error'); if(err){ err.textContent=msg; err.style.visibility='visible'; } }
        return ok;
      };
      const validateCurrentStep=()=>{ let ok=true; stepFields[currentStep].forEach(id=>{ if(!validateField(id)) ok=false; }); return ok; };
      Object.values(stepFields).flat().forEach(id=>{ const el=document.getElementById(id); if(el && el.name!=='onset' && el.name!=='gender'){ const evt=(el.tagName==='SELECT'||el.type==='file')?'change':'blur'; el.addEventListener(evt,()=>validateField(id)); }});

      /* Results accordion (mock) */
      const mockDiagnoses=[
        {name:"اگزما (درماتیت آتوپیک)",description:"اگزما یک بیماری التهابی پوست است که باعث خشکی، خارش و قرمزی می‌شود.",color:"blue"},
        {name:"پسوریازیس",description:"بیماری خودایمنی با لکه‌های قرمز و پوسته‌پوسته.",color:"purple"},
        {name:"آکنه ولگاریس",description:"مسدود شدن منافذ و ایجاد جوش.",color:"red"},
        {name:"روزاسه",description:"قرمزی صورت و برجستگی‌های کوچک.",color:"rose"},
        {name:"درماتیت تماسی",description:"در اثر تماس با محرک/آلرژن.",color:"green"}
      ];
      function displayResults(results){
        const wrap=document.getElementById('analysis-results-accordion'); wrap.innerHTML='';
        const colorClasses={blue:{bg:'bg-blue-100',text:'text-blue-800'},purple:{bg:'bg-purple-100',text:'text-purple-800'},red:{bg:'bg-red-100',text:'text-red-800'},rose:{bg:'bg-rose-100',text:'text-rose-800'},green:{bg:'bg-green-100',text:'text-green-800'}};
        results.forEach(r=>{
          const colors=colorClasses[r.color]||colorClasses.blue;
          const item=document.createElement('div');
          item.className='accordion-item';
          item.innerHTML=`<div class="accordion-header flex justify-between items-center p-4 rounded-lg ${colors.bg} ${colors.text}">
              <h3 class="font-semibold">${r.name}</h3>
              <svg class="accordion-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </div>
            <div class="accordion-content"><p>${r.description}</p></div>`;
          wrap.appendChild(item);
        });
        wrap.querySelectorAll('.accordion-header').forEach(h=>{
          h.addEventListener('click',()=>{
            const item=h.parentElement; const content=h.nextElementSibling; const was=item.classList.contains('active');
            wrap.querySelectorAll('.accordion-item.active').forEach(ai=>{ ai.classList.remove('active'); ai.querySelector('.accordion-content').style.maxHeight=null; });
            if(!was){ item.classList.add('active'); content.style.maxHeight=content.scrollHeight+50+"px"; }
          });
        });
      }

      /* Reset */
      function resetForm(){
        form.reset();
        document.querySelectorAll('.symptom-tag.selected').forEach(t=>t.classList.remove('selected'));
        onsetLabel.textContent='مدت زمان را انتخاب کنید...'; onsetLabel.classList.add('text-gray-500');
        removeFileBtn.click();
        genderInput.value=''; onsetInput.value=''; symptomsInput.value='';
        document.querySelectorAll('.validation-error-message').forEach(m=>{m.style.visibility='hidden'; m.textContent='';});
        document.querySelectorAll('.input-error').forEach(el=>el.classList.remove('input-error'));
        mainContainer.classList.remove('results-shown'); successMessage.classList.add('hidden'); resultsButtons.classList.add('hidden');
        progressContainer.classList.remove('hidden'); formStepsContainer.classList.remove('hidden'); navigationButtons.classList.remove('hidden');
        document.getElementById('header-subtitle').textContent='برای دریافت یک تحلیل اولیه، لطفاً فرم زیر را با دقت تکمیل نمایید.';
        goToStep(1); ageInput.focus();
      }
      window.resetForm=resetForm;
      startAgainButton.addEventListener('click',resetForm);

      /* Menu logic (with divider fix) */
      const menuButton=document.getElementById('menu-button');
      const menuDropdown=document.getElementById('menu-dropdown');
      const installBtn=document.getElementById('menu-install');
      const updateBtn=document.getElementById('menu-update');
      const divider=document.getElementById('menu-divider');
      const shareBtn=document.getElementById('menu-share');
      const resetBtn=document.getElementById('menu-reset');
      const aboutBtn=document.getElementById('menu-about');

      function toggleMenu(show){
        const shouldShow=typeof show==='boolean'?show:menuDropdown.classList.contains('hidden');
        if(shouldShow){ menuDropdown.classList.remove('hidden'); menuButton.setAttribute('aria-expanded','true'); }
        else{ menuDropdown.classList.add('hidden'); menuButton.setAttribute('aria-expanded','false'); }
      }
      menuButton.addEventListener('click',e=>{ e.stopPropagation(); toggleMenu(); });
      document.addEventListener('click',e=>{ if(!menuDropdown.contains(e.target)&&!menuButton.contains(e.target)) toggleMenu(false); });
      document.addEventListener('keydown',e=>{ if(e.key==='Escape') toggleMenu(false); });

      function isAppInstalled(){ return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone===true; }

      window.refreshPWAButtons=function refreshPWAButtons(){
        const installed=isAppInstalled();
        const canInstall=!!deferredPrompt && !installed;
        const hasUpdate=!!waitingWorker;

        // hide both by default
        installBtn.classList.add('hidden');
        updateBtn.classList.add('hidden');

        if(hasUpdate){ updateBtn.classList.remove('hidden'); }
        else if(canInstall){ installBtn.classList.remove('hidden'); }

        // 🔧 divider appears only if at least one of install/update is visible
        const showDivider = hasUpdate || canInstall;
        divider.classList.toggle('hidden', !showDivider);
      };

      installBtn.addEventListener('click',async ()=>{
        if(!deferredPrompt){
          const isIOS=/iphone|ipad|ipod/i.test(navigator.userAgent);
          alert(isIOS?'در iOS از Share → Add to Home Screen استفاده کنید.':'در حال حاضر نصب‌پذیر نیست.');
          return;
        }
        deferredPrompt.prompt();
        try{ await deferredPrompt.userChoice; }catch{}
        deferredPrompt=null; refreshPWAButtons();
      });

      updateBtn.addEventListener('click',()=>{ if(waitingWorker) waitingWorker.postMessage({type:'SKIP_WAITING'}); });

      shareBtn.addEventListener('click',async ()=>{
        toggleMenu(false);
        const data={title:'SkinGenius',text:'یک دستیار هوشمند برای تحلیل اولیه مشکلات پوستی',url:location.href};
        if(navigator.share){ try{ await navigator.share(data);}catch{} }
        else{
          try{ await navigator.clipboard.writeText(location.href); alert('لینک کپی شد ✅'); }
          catch{ prompt('مرورگر از کپی خودکار پشتیبانی نمی‌کند. لطفاً لینک را دستی کپی کنید:',location.href); }
        }
      });
      resetBtn.addEventListener('click',()=>{ toggleMenu(false); if(confirm('آیا از شروع مجدد فرم مطمئن هستید؟')) resetForm(); });
      aboutBtn.addEventListener('click',()=>{ toggleMenu(false); alert('SkinGenius — نسخهٔ نمایشی\nاین ابزار جهت اطلاع‌رسانی اولیه بوده و جایگزین پزشک نیست.'); });

      document.addEventListener('visibilitychange',()=>{ if(!document.hidden) refreshPWAButtons(); });
      refreshPWAButtons();

      /* Submit */
      form.addEventListener('submit',e=>{
        e.preventDefault();
        if(validateCurrentStep()){
          const txt=document.getElementById('submit-button-text');
          const spn=document.getElementById('submit-spinner');
          submitButton.disabled=true; txt.classList.add('hidden'); spn.classList.remove('hidden');
          setTimeout(()=>{
            submitButton.disabled=false; txt.classList.remove('hidden'); spn.classList.add('hidden');
            mainContainer.classList.add('results-shown');
            document.getElementById('header-subtitle').textContent='نتایج تحلیل شما در زیر ارائه شده است.';
            formStepsContainer.classList.add('hidden'); navigationButtons.classList.add('hidden'); progressContainer.classList.add('hidden');
            successMessage.classList.remove('hidden'); resultsButtons.classList.remove('hidden'); displayResults(mockDiagnoses);
          },1500);
        }
      });

      goToStep(1);
    });
  </script>
</body>
</html>